PART 1 — Stack-1: Create S3 Bucket (CloudFormation)
Step 1.1: Create S3 template file
Create a file: stack1-s3-bucket.yaml and paste:
AWSTemplateFormatVersion: "2010-09-09"
Description: Create an S3 bucket to store website content (index.html)
Resources:
  WebsiteBucket:
    Type: AWS::S3::Bucket

Outputs:
  BucketName:
    Description: S3 Bucket Name (use this to upload index.html)
    Value: !Ref WebsiteBucket
Step 1.2: Create stack
CloudFormation → Stacks → Create stack → With new resources
Choose an existing template
Upload a template file → stack1-s3-bucket.yaml
Stack name: S3-Website-Bucket
Create stack
Step 1.3: Copy bucket name
Open stack → Outputs → copy BucketName

PART 2 — Upload Static Content to S3 (Manual)
Step 2.1: Create index.html on your PC
Create a file named index.html with this content:
<!DOCTYPE html>
<html>
<head>
  <title>EC2 + S3 Demo</title>
</head>
<body>
  <h1>Hello! This page was pulled from S3 to EC2 automatically.</h1>
  <p>Deployed using CloudFormation + UserData</p>
</body>
</html>
Step 2.2: Upload to S3 bucket
S3 → Buckets → open your bucket (from Output) → Upload
Upload index.html
Keep it at root (no folder)
Upload
Now S3 has: s3://<your-bucket-name>/index.html

PART 3 — Stack-2: Launch EC2 + Apache + Pull from S3
This stack will:
Create IAM Role (permission to read the bucket)
Create Security Group (22, 80)
Launch EC2 (Amazon Linux 2023)
Install Apache
Copy index.html from S3 to /var/www/html/index.html
Step 3.1: Create EC2 template file
Create a file: stack2-ec2-pull-from-s3.yaml and paste:
AWSTemplateFormatVersion: "2010-09-09"
Description: Launch EC2 (Amazon Linux 2023), install Apache, and pull index.html from S3

Parameters:
  KeyName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: Select an existing EC2 Key Pair to enable SSH access

  BucketName:
    Type: String
    Description: Enter the S3 bucket name created in Stack-1 (Output)

  SubnetId:
    Type: AWS::EC2::Subnet::Id
    Description: Select a PUBLIC subnet (default VPC public subnet recommended)

  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: Select the VPC (default VPC recommended)

Resources:
  WebServerRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: S3ReadOnlyForWebsiteBucket
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:ListBucket
                Resource:
                  - !Sub "arn:aws:s3:::${BucketName}"
                  - !Sub "arn:aws:s3:::${BucketName}/*"

  WebServerInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref WebServerRole

  WebServerSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow SSH (22) and HTTP (80)
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0

  WebServerInstance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t2.micro
      KeyName: !Ref KeyName
      SubnetId: !Ref SubnetId
      SecurityGroupIds:
        - !Ref WebServerSG
      IamInstanceProfile: !Ref WebServerInstanceProfile

      # Amazon Linux 2023 AMI for Mumbai (ap-south-1)
      ImageId: ami-02b49a24cfb95941c

      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          dnf update -y
          dnf install -y httpd
          systemctl enable httpd
          systemctl start httpd

          # pull index.html from S3 to Apache web root
          aws s3 cp s3://${BucketName}/index.html /var/www/html/index.html

          systemctl restart httpd

Outputs:
  WebsiteURL:
    Description: Open this URL in browser
    Value: !Sub "http://${WebServerInstance.PublicDnsName}"

Step 3.2: Create stack
CloudFormation → Stacks → Create stack
Upload template → stack2-ec2-pull-from-s3.yaml
Stack name: EC2-Pull-S3-Website
Parameters:
KeyName: select your key pair (e.g., pemkeypair)
BucketName: paste bucket name from Stack-1 Output
VpcId: select default VPC
SubnetId: select a PUBLIC subnet in default VPC
(usually the subnet name shows “public” or you can pick any default subnet that gives public IP; default subnets generally work)
Create stack → wait for CREATE_COMPLETE

PART 4 — Verify Output
Stack-2 → Outputs → copy WebsiteURL → open in browser.
Expected page:
“Hello! This page was pulled from S3 to EC2 automatically…”

Troubleshooting (comm
1) Website not opening
Wait 1–2 minutes (UserData takes time)
Ensure Security Group has HTTP 80 open
Ensure you selected a public subnet (needs internet to reach S3)
2) Stack-2 fails with S3 access error
BucketName typed wrong
index.html not uploaded at root of bucket

Clean-up
Delete Stack-2 first
CloudFormation → select EC2-Pull-S3-Website → Delete
Empty the S3 bucket
S3 → bucket → delete index.html (empty bucket)
Delete Stack-1
CloudFormation → select S3-Website-Bucket → Delete
